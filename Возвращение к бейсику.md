Возвращение к бейсику
=====================

  
2023-03-05, 05:08  
 При программировании микроконтроллеров применяются конечные автоматы. Это позволяет добиться двух вещей:   
 -- Избежать миллиона флагов, следящих, что конкретно происходит в программе   
 -- Выполнять действия асинхронно, не используя при этом многопоточность или прерывания.   
   
 Покажу короткий автомат, который посылает запрос, ждёт ответа, а потом возвращается к началу.   
   
 
```
  
void main(void)
{
    for( ;; )
        {
            //главный цикл микроконтроллера
            automaton();//вызов автомата
            //таких автоматов в главном цикле могут быть десятки, каждый занимается своим делом
            //и друг другу не мешают
        }
    return 0;
}

void automaton()
{
    static int state=0;
    switch(state)
        {
            case 0:
                send_request();
                state=1;
                break;
            case 1:
                if(answer_ready())
                    state=2;
                break;//если условие не выполнено, state остаётся равным 1
            case 2:
                read_answer();
                state=0;
                break;
        }  
}
```
   
   
 Что тут происходит: при каждом вызове автоматной функции она начинает выполнять кусок кода, соответствующий текущему состоянию. В зависимости от состояния происходит переход к следующему куску. Тут куска всего три.   
 0: перейти к 1   
 1: если ответ готов, перейти к 2. если не готов, остаться в 1   
 2: перейти к 0   
   
 Можно нарисовать схему, но я этого делать не буду.   
   
 Так вот, в чём проблема: в обозначении состояний. Я в своих автоматах состояния просто нумерую 0, 1, 2...   
 А мой коллега из дружественной организации даёт состояниям названия, например, FSM\_INITIAL\_STATE.   
   
 И оба подхода плохие.   
   
 Номера:   
 -- цифры бессмысленны, без комментариев непонятно, зачем нужен переход и куда мы переходим   
 -- если необходимо внести промежуточные состояния, то либо приходится их размещать в конце автоматной функции (с бОльшими номерами), либо сдвигать нумерацию   
   
 Названия:   
 -- осмысленные названия состояний получаются очень длинными, могут даже приближаться к длине самого кода, который выполняет данное состояние (например, выше нулевое состояние можно назвать FSM\_SEND\_REQUEST)   
 -- видя название состояния, тяжело понять, где его искать в автоматной функции. Выше оно или ниже текущей строки, текущего состояния? Или каждый раз пользоваться поиском?   
   
 Однозначного решения у меня нет. Может быть, об этом написано в какой-то книжке про автоматы, но я их не читал. У меня есть решение только одной из проблем.   
   
 Все помнят бейсик? Что там строчки нумеровались 10, 20, 30. А зачем они так нумеровались? А как раз для того, чтобы между строчками можно было впихнуть ещё парочку строк не проводя полной перенумерации.   
   
 Вот и решение. Состояния можно нумеровать не 0, 1, 2, а 0, 10, 20.   
  
<https://diary.ru/~zHz00/p221557637_vozvrawenie-k-bejsiku.htm>  
  
Теги:  
[[Программирование]]  
[[Статьи]]  
ID: p221557637  


Комментарии: 13
---------------

  


---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (1/13) | 2023-03-05, 11:19 | Гость | c755461081 |

  
 Осмысленное название всегда лучше цифр.   
 ^c755461081

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (2/13) | 2023-03-05, 16:09 | Xersareeth | c755461974 |

  
 Чота я не понял, у тебя state не глобальная переменная? Не будет ли automaton() всегда делать send\_request в этом коде?   
 ^c755461974

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (3/13) | 2023-03-05, 17:12 | RetXiRT suiR@ttig@$ | c755462264 |

  
 Ну, я лично прибавляю 2 и далее, если надо впихнуть между:   
 1   
 2   
 22   
 23   
 3   
 ^c755462264

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (4/13) | 2023-03-05, 17:21 | zHz00 | c755462298 |

  
  **Гость**  , вот с одной стороны всегда, а с другой -- есть проблемы, я написал какие. Если прочитаю или придумаю безнедостаточное решение -- напишу.   
  [Xersareeth](https://BurrowDeclassified.diary.ru "One more fang")  , это статическая переменная. Статические переменные размещаются не на стеке, а в глобальной области, но доступ к ним есть только внутри функции. Кстати буквально вчера мне в отладочных целях пришлось такой стейт вывести в глобальное пространство, чтобы видеть, где автомат болтается.   
  [RetXiRT suiR@ttig@$](https://Hellspawn.diary.ru "Atomicautionuclear")  , не понял. То есть, у тебя числа не по порядку получаются?   
 ^c755462298

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (5/13) | 2023-03-05, 19:00 | kshisia fialkina | c755462648 |

  
  спокойно у вас, хорошо.    
  [zHz00](https://zHz00.diary.ru "Untitled")  , простите (  снова  ) за флуд!   
  [RetXiRT suiR@ttig@$](https://Hellspawn.diary.ru "Atomicautionuclear")  , а можно почаще этот аватар? концептуально очень)   
 ^c755462648

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (6/13) | 2023-03-05, 20:37 | Xersareeth | c755463081 |

  
  ~~А вот у нас в рубях...~~  Я как-то писал похожую штуку, но у меня автомат лежал в ассоциативном массиве в таком виде:   
   
 fsm = {1 => {new\_value: 2, func\_name: 'send\_request'},2 => {new\_value: 3, func\_name: 'check\_answer'},3 => {new\_value: 1, func\_name: 'read\_answer'}}   
   
 Ну и код обработчика:   
 loop do old\_value = value new\_value = fsm[old\_value][:new\_value] func\_name = fsm[old\_value][:func\_name] result = send(func\_name) # вызов функции по названию в переменной value = new\_value if result == trueend   
   
 Приятно когда получается такие штуки писать вместо бесконечных select case =)   
 ^c755463081

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (7/13) | 2023-03-05, 23:16 | RetXiRT suiR@ttig@$ | c755463650 |

  
   [zHz00](https://zHz00.diary.ru "дневник Untitled")  , ну отчего же:   
 первый   
 второй   
 второй 2   
 второй 3   
 третий   
   [kshisia fialkina](https://kshisi-as-they-are.diary.ru "дневник Don't think about white rabbit")  , я уже говорил - выбор аватаров у меня не пашет.   
 ^c755463650

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (8/13) | 2023-03-06, 05:46 | Foul thing | c755464126 |

  
 Почему не использовать enum?   
   
 enum States { state1, state2, state3 };   
   
 Для расширения просто добавляешь новое имя:   
   
 enum States { state1, state1\_1, state1\_2, state2, state3 };   
   
 Опять же, если имена пронумерованы, по ним всегда можно однозначно определить, в каком они отношении состоят друг с другом - кто выше, кто ниже.   
 ^c755464126

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (9/13) | 2023-03-06, 19:31 | kshisia fialkina | c755466153 |

  
  [RetXiRT suiR@ttig@$](https://Hellspawn.diary.ru "Atomicautionuclear")  , и не один раз   
   
 /в сторону: ну почему ирония никогда не прокатывает?../   
 ^c755466153

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (10/13) | 2023-03-06, 23:23 | RetXiRT suiR@ttig@$ | c755466899 |

  
   [kshisia fialkina](https://kshisi-as-they-are.diary.ru "дневник Don't think about white rabbit")  , вот эти все с дайревским псом сделаны одной из дайри-юзерш, либо по мотивам высказываний бывшего хозяина дайри, либо прямые цитаты. Пиар-отдела у него не было, предпочитал сам прямо общаться с юзерами... +)   
 А то, на что вы жалуетесь, называется закон По (Poe's Law).   
 ^c755466899

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (11/13) | 2023-03-07, 00:45 | korrshun | c755467066 |

  
 ну нынешний state of the art предлагает кодогенерацию для написания конечных автоматов.   
  [smc.sourceforge.net/](https://smc.sourceforge.net/)    
 Для плюсов есть шаманство на шаблонах, например, в boost.   
  [www.boost.org/doc/libs/1\_31\_0/libs/mpl/doc/pape...](https://www.boost.org/doc/libs/1_31_0/libs/mpl/doc/paper/html/example.html)    
 а ещё пишут библиотеки на макросах.   
 <https://github.com/endurodave/C_StateMachine>   
   
 Ни в одну из них я не лазил, так что говорить за это не буду.   
 Я-то человек ленивый, у меня обычно просто были таблички указателей на обработчики и матрица инциндентности.   
 ^c755467066

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (12/13) | 2023-03-07, 16:55 | kshisia fialkina | c755469253 |

  
  [RetXiRT suiR@ttig@$](https://Hellspawn.diary.ru "Atomicautionuclear")  , c "четким указанием" уже неинтересно)   
  да, нос(а) не хватает. у него здорово было просто поприсутствовать...    
 ^c755469253

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (13/13) | 2023-03-07, 22:24 | zHz00 | c755470660 |

  
  [Foul thing](https://foulthing.diary.ru "Temporary Internet Flies")  , хорошая идея! Надо поэкспериментировать, как голый Си будет себя вести при одинаковых названиях констант у разных типов.   
  [korrshun](https://Igel-kun.diary.ru "kimi wo shiranai monogatari")  , ого, тема-то насущная. Спасибо, буду изучать.   
 ^c755470660