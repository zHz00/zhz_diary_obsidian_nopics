Вавилонская башня
==================

   
 2017-03-20, 23:59   
  Микроконтроллер выдает HardFault (аппаратная ошибка). После какой конкретно строчки программы он туда вываливается по техническим причинам выследить невозможно.   
   
 Смотрю -- происходит это по адресу 0x1800 0000. Там как раз заканчивается настоящая оперативная память и начинает пустое адресное пространство. Ставлю точку останова по адресу 0x17FF FFFA -- недалеко от конца. Но она не срабатывает. Вывод -- в этот адрес упирается не программа, а данные.   
   
 Нахожу в коде следующий текст:   
   
 
```
char out\_buf[200];  
char temp\_buf[20];<br>int x;<br>int a,b,r[10];<br>// ---<br><br>//sprintf(out\_buf,"%d\n",a);<br>sprintf(temp\_buf,"%d\n",b);<br>strcat(out\_buf,temp\_buf);<br>for(x=0;x<10;x++)<br>	{<br>		sprintf(temp\_buf,"%d\n",r[x]);//напечатать очередной кусок текста в строку<br>		strcat(out\_buf,temp\_buf);//добавить к основной результирующей строке<br>	}  
//...
```
   
   
 Вопрос о том, зачем нужны sprintf в прошивке, где в текстовых данных нет особой необходимости, оставляю за кадром. Так надо.   
   
 sprintf печатает в строку, strcat сшивает (конкатенирует) две строки.   
   
 Данный кусок выполняется в основном бесконечном цикле прошивки.   
 Первый вызов sprintf закомментирован. Он попал под раздачу, т.к. отвечал за одну из функций прошивки, которая была больше не нужна. Вместо её удаления, я её закомментировал. И правильно сделал. Благодаря этому я легко смог опознать, в чём же было дело.   
   
 Эта закомментированная строка писала в выходной буфер с его начала. А остальные операторы дописывали к его концу. Когда же я строку закомментировал, при каждой следующей итерации новые данные дописывались в конец строки. Которая всё удлинялась и удлинялась. Пока не упёрлась в конец памяти!   
   
 Решением в данном случае было дописать после закомментированной строки:   
   
 out\_buf[0]='\0';   
   
 Тогда заполнение стало происходить с нуля каждый раз.   
   
  P.S. Только что подумал, что можно оптимизировать, сделав:   
   
 sprintf(out\_buf+strlen(out\_buf),"%d\n",r[x]);    
    
 <https://diary.ru/~zHz00/p212303542_vavilonskaya-bashnya.htm>   
   
 Теги:   
 [[Программирование]]   
 [[Борьба с техникой]]   
 ID: p212303542