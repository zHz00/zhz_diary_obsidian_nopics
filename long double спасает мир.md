long double спасает мир
=======================

  
2020-08-12, 23:59  
 Дважды за день попался на "детских" ошибках с вычислениями.   
   
 Надо было перенести вычислительный алгоритм с компа в микроконтроллер.   
   
 1. Я был предупреждён, что в PIC32 типы float и double эквивалентны. Если хочешь получить что-то побольше, чем 32 бита, надо писать long double. Поэтому я решил -- а, пофиг, напишу float. Алгоритм заработал, но в одном месте показывал смещённые результаты. Причём чем дальше, тем больше было смещение. Да, это набегала ошибка при проведении повторяющихся операций (сложения). Написал long double, заработало.   
   
 2. В другом месте решил, что чтобы было поточнее, буду пока есть возможность проводить вычисления с целыми числами. Там было умножение. Я перемножил два инта. А потом смотрю, чего это у меня результаты вычислений не зависят ни от чего вообще. Что ни делаю, получаю 0.5 повторяемо (после всех других вычислений). Эти инты содержали в себе результаты считывания с 18-битного АЦП. А произведение двух 18-битных чисел это 36-битное число. Оно не влезало в 32-битную разрядную сетку. У меня постоянно возникало переполнение. Стал эти числа приводить к long double ещё до умножения. Сразу всё стало правильно.   
  
<https://diary.ru/~zHz00/p219790980_long-double-spasaet-mir.htm>  
  
Теги:  
[[Программирование]]  
[[Говнокод]]  
[[Борьба с техникой]]  
ID: p219790980  


Комментарии: 7
--------------

  


---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (1/7) | 2020-08-13, 04:03 | CD\_Eater | c748491757 |

  
 а там и float, и long double эмулируются программно?   
 ^c748491757

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (2/7) | 2020-08-13, 08:59 | zHz00 | c748492583 |

  
  [CD\_Eater](http://cd-eater.diary.ru "Записки ДискоЕда")  , смотря в какой модификации. В том МК, на котором я работаю, якобы установлен мат. сопроцессор. Но типы данных компилятора-то не зависят от наличия сопроцессора (если принять, что выпускаются модификации такого же МК без него). Надо ещё узнать, какая длина у лонг дабла -- 8 или 10 байт.   
 ^c748492583

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (3/7) | 2020-08-13, 11:44 | Hikedaya | c748494465 |

  
  У меня постоянно возникало переполнение    
 И при этом не генерилась ошибка?   
 ^c748494465

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (4/7) | 2020-08-13, 12:04 | zHz00 | c748494755 |

  
  [Hikedaya](http://hikedaya.diary.ru "Записная книжка")  , нет, конечно. Это же Си.   
 ^c748494755

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (5/7) | 2020-08-13, 19:10 | korrshun | c748500677 |

  
  [zHz00](https://zHz00.diary.ru "Untitled")  , строго говоря, ты можешь насовать везде ассертов с  [gcc.gnu.org/onlinedocs/gcc/Integer-Overflow-Bui...](https://gcc.gnu.org/onlinedocs/gcc/Integer-Overflow-Builtins.html)    
 или эта версия gcc это не поддерживает?   
 ^c748500677

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (6/7) | 2020-08-13, 19:41 | CD\_Eater | c748501071 |

  
  В том МК, на котором я работаю, якобы установлен мат. сопроцессор.    
 и что именно он поддерживает аппаратно?   
   
 а что вообще пик32 умеет?   
 он хотя бы целочисленное умножение 32х32=64 умеет?   
 а целочисленное деление?   
 ^c748501071

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (7/7) | 2020-08-16, 13:33 | zHz00 | c748537632 |

  
  [CD\_Eater](http://cd-eater.diary.ru "Записки ДискоЕда")  , так, что поддерживает аппаратно.   
   
 Поддерживает работу с типами с плавающей точкой длиной 32 и 64 бита. 80 бит, видимо, не поддерживает. Какие операции конкретно пока выяснить не удалось.   
   
 Умножение и деление целочисленное, в том числе 32\*32=>64 умеет. Для этого в процессоре существует отдельный блок. Результат записывается в специальные два регистра, для этого предназначенные. По-видимому, умножение и деление не работает в один такт, т.к. указано, что пока умножитель/делитель работает могут выполняться иные операции. Но сколько операция выполняется, пока выяснить не удалось.   
   
 В документации на пик32 отсутствует система команд, присутствуют только отсылки на стандартную архитектуру MIPS32 release 2.   
 ^c748537632