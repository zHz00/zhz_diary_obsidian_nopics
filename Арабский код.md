Арабский код
============

  
2018-10-24, 23:59  
 Коллегам из дружественной организации как-то раз надо было в микроконтроллерной программе разворачивать числа задом наперёд.   
   
 То есть, вот у нас число 183 (0b10110111), а надо было, чтобы число стало 237 (0b11101101). Как это можно сделать?   
   
 Ну, можно пробежаться по числу циклом, сдвигая его вправо, брать младший бит и прибавлять к результирующему числу, которое одновременно сдвигать влево.   
   
 Но это очень долго. Они хотели быстро! Поэтому они сделали массив, содержащий в себе все возможные варианты конечных чисел. Выбирая число по индексу, можно было получить ответ. В случае с приведённым выше примером, было так:   
   
 res=table[183];//res==237   
   
 Это был эффективный метод. Только числа были не восьмибитные, а шестнадцатибитные. Посчитаем, сколько занимала такая таблица в памяти?   
   
 65536\*2=128 KiB   
   
 А размер всей прошивки был 512 KiB. То есть, четверть (!) всего места занимала эта таблица. Её можно было бы сгенерировать динамически в оперативной памяти, но оперативной памяти было ещё меньше.   
   
 Для их задачи потеря четверти прошивки на такую таблицу была не критична. Но такое решение мне казалось нерациональным. Тем не менее, лучшего я всё равно не знал. Тогда.   
   
 Потом я изучил ассемблер того контроллера. А контроллер был архитектуры ARM Cortex-M. По идее, это RISC-контроллер. Однако в его наборе команд есть много полезных штучек, делающих специфичные вещи, которые иначе занимали бы много команд. Это противоречит идеологии RISC, но удобно. Например, есть команда, считающая число ведущих нулей в числе. Или команда, расширяющая знаковое число любой указанной битности до знакового числа стандартной битности (16, 32). И даже  [команды работы со стеком](Как%20работает%20стек%20в%20PIC32%20(MIPS))  были!   
   
 И вот среди этих команд я нашёл команду RBIT. Она делала именно то, что хотели эти ребята -- переворачивала биты задом наперёд. В один такт.   
   
 Выводы и мораль писать лень.   
  
<https://diary.ru/~zHz00/p216469702_arabskij-kod.htm>  
  
Теги:  
[[Программирование]]  
[[Говнокод]]  
ID: p216469702  


Комментарии: 10
---------------

  


---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (1/10) | 2018-10-25, 12:43 | deadlymercury | c736042000 |

  
 Почему-то вспомнилось)   
 "Это канал об аниме? - Да - Как пропатчить KDE2 под FreeBSD?"   
 ^c736042000

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (2/10) | 2018-10-25, 12:50 | zHz00 | c736042143 |

  
 :-О странно. Непонятная ассоциация.   
 ^c736042143

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (3/10) | 2018-10-25, 14:41 | RetXiRT suiR@ttig@$ | c736044912 |

  
   [zHz00](https://zHz00.diary.ru "Untitled")  , просто вы слишком молоды, мой мальчик, кхе-кхе-кхе… ![:old:](http://static.diary.ru/picture/498119.gif)    
 ^c736044912

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (4/10) | 2018-10-25, 16:10 | Стороной | c736047103 |

  
 Зато код независимый получился от расширенного набора команд.   
   
 ЗЫ. Если им надо байт, то одной командой не обойтись, это 32-битная команда. )   
 ^c736047103

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (5/10) | 2018-10-25, 16:22 | zHz00 | c736047379 |

  
  [RetXiRT suiR@ttig@$](http://Hellspawn.diary.ru "Горчичник")  , это вроде одна из первых цитат на баш орг ру, нет?   
   
  [Стороной](http://1047.diary.ru "И васильки, и я, и тополя")  , ну тут как обычно всё зависит от задачи. Нужен им портируемый код или нет. Делать "лишь бы было портируемо" без необходимости, имхо, смысла нет.   
   
 А что команда работает с 32-битными операндами это не проблема, т.к. после неё можно сделать сдвиг на 16/24 бит вправо.   
 ^c736047379

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (6/10) | 2018-10-26, 07:09 | RetXiRT suiR@ttig@$ | c736062552 |

  
   [zHz00](https://zHz00.diary.ru "Untitled")  , ![:susp:](http://static.diary.ru/picture/1484.gif) …не одна из, а та самая с  *Абсолютным Числом*  в номере!    
 ^c736062552

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (7/10) | 2018-10-26, 07:25 | zHz00 | c736062630 |

  
  [RetXiRT suiR@ttig@$](http://Hellspawn.diary.ru "Горчичник")  , нагуглил. Но ассоциация всё равно непонятная!   
 ^c736062630

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (8/10) | 2018-10-27, 15:08 | Гость | c736093407 |

  
 Не понимаю, почему нельзя было сделать табличку на 256 записей, разбить входное число на байты, перевернуть каждый и склеить обратно:   
   
 ```c   
 extern unsigned char table[256];   
   
 unsigned short reverse(unsigned short input) {   
 const unsigned char lo = input & 0xff;   
 const unsigned char hi = (input & 0xff00) >> 8;   
   
 // После переворачивания старший байт становится младшим и наоборот   
 const unsigned short top = table[lo];   
 const unsigned short bottom = (unsigned short)table[hi] << 8;   
   
 const unsigned short result = top | bottom;   
   
 return result;   
 }   
 ```   
   
 Не в одну инструкцию, конечно, но тоже достаточно эффективно получается:  [godbolt.org/z/i1bNle](https://godbolt.org/z/i1bNle)    
 ^c736093407

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (9/10) | 2018-10-27, 15:09 | Гость | c736093424 |

  
 Забыл подписаться. Это я, Minoru!   
 ^c736093424

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (10/10) | 2018-10-27, 15:13 | zHz00 | c736093501 |

  
 Дыаа, этот вариант лучше, чем 128 кб! Спасибо.   
 ^c736093501