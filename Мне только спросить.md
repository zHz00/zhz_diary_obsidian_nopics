Мне только спросить
===================

  
2014-10-06, 23:47  
 Программа должна была через примерно равные промежутки времени (около 200 микросекунд) делать определённые действия и выдавать на выходе файл с данными. Однако когда данные из файла представляли в виде графика, было чётко видно, что при переходе от этапа 1 к этапу 2 наблюдается дыра (пауза) около 1 миллисекунды. Эта дыра нас не устраивала.   
   
 Начальство предложило функции, в которые были зашиты этапы 1 и 2 (алгоритмы), развернуть и вставить в основную функцию. Я крутил и так и сяк, пытался какие-то предварительные действия вынести в основную функцию, не убирая полностью внутренние, но дыра не пропадала. Однако полностью запихивать функции этапа 1 и 2 в основную было  [плохой идеей](https://nethackwiki.com/mediawiki/index.php?title=Bad_Idea)  , потому что эти функции использовались ещё в шести местах, кроме того, они вызвали ещё десять других функций, и, если дело было во времени вызова, то исключить те вызовы уже не удалось бы никак. Тогда у меня возникла невероятная догадка -- единственные две операции (кроме непосредственно вызова функций), которые могли занимать время (из оставшихся) -- это вывод сообщения в окошечко на экране и вывод отладочного сообщения в лог-файл (не в файл с данными, а в файл с отладочными сообщениями).   
   
 Я закомментировал вывод на экран и в лог-файл и -- о чудо -- пауза пропала! Дальнейшие изыскания выявили, что дело было в обращении к жёсткому диску (в файл с данными данные пишутся один раз -- в конце). Не думал, что лично столкнусь с ситуацией, когда в лог-файл писать  *некогда*  . Хотя меня когда-то предупреждали, что такое бывает. В таких случаях лог-файл пишут в память, а потом иногда сбрасывают на диск.   
  
<https://diary.ru/~zHz00/p200303046_mne-tolko-sprosit.htm>  
  
Теги:  
[[Программирование]]  
[[Борьба с техникой]]  
ID: p200303046  


Комментарии: 14
---------------

  


---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (1/14) | 2014-10-07, 00:15 | Гость | c675418722 |

  
 Можно ли написать программу, которая полностью заменит Президента?   
 ^c675418722

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (2/14) | 2014-10-07, 09:27 | Foul thing | c675429455 |

  
 Потестил скорость логирования. Если писать через fstream, получается в среднем 34 микросекунды на запись. Если через FILE/fwrite, то 0.4 микросекунды.   
   
 Самое ужасное, что он при этом пишет за секунду в лог несколько мегабайт текста.   
 ^c675429455

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (3/14) | 2014-10-07, 09:48 | zHz00 | c675430197 |

  
  [Foul thing](http://foulthing.diary.ru "Temporary Internet Flies")  , там самописная (не мной) функция логирования, которая каждый вызов открывает и закрывает файл. И что-то ещё делает.   
 ^c675430197

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (4/14) | 2014-10-07, 14:44 | UNKNOWN | c675445560 |

  
 Вот это техника - пауза в 1 млсек не устраивает!   
 ^c675445560

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (5/14) | 2014-10-07, 16:55 | zHz00 | c675453436 |

  
  **Гость**  , да, нужно 10 месяцев и 5 аспирантов (С) Фредерик Пол // Человек-схема (найти в интернете текстовую версию данного рассказа нереально, так что придётся послушать аудиоверсию в "Модели для сборке", это найти можно).   
  [Foul thing](http://foulthing.diary.ru "Temporary Internet Flies")  , да, а ты проводил в тестах очистку буфера после каждой записи?   
  [z4s00](http://z4s00.diary.ru "Kitsuneko's eye")  , при времени проведения операций (измерений) 200 мкс, 1 мс это целых пять точек!   
 ^c675453436

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (6/14) | 2014-10-07, 18:42 | Foul thing | c675459785 |

  
 Не производил. А зачем? И какого конкретно?   
 ^c675459785

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (7/14) | 2014-10-07, 21:27 | zHz00 | c675470561 |

  
  [Foul thing](http://foulthing.diary.ru "Temporary Internet Flies")  , буфера лог-файла. Выходного. Зачем -- если программа упадёт, то буфер не выведется на диск, и мы не узнаем, что происходило. А зачем нам тогда лог-файл?   
 ^c675470561

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (8/14) | 2014-10-07, 21:40 | Foul thing | c675471662 |

  
 Не очень понятно, как это у вас устроено. Ты формируешь в памяти одну строку, допустим, "ф-ция А отработала успешно, всем привет" и пишешь ее в файл. И где тут буфер, и зачем его очищать? Нипанимай.   
 ^c675471662

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (9/14) | 2014-10-07, 21:59 | zHz00 | c675473212 |

  
  [Foul thing](http://foulthing.diary.ru "Temporary Internet Flies")  , ну, буфер записи в файл. Данные же не сразу пишутся на диск, а сначала накапливаются в специальном хранилище, а потом направляются на диск чушкой в 4 килобайта, к примеру. Пока буфер не очищен, они валяются в памяти!   
   
 На примере fstream, манипулятор flush:   
  [www.cplusplus.com/reference/ostream/flush-free/](http://www.cplusplus.com/reference/ostream/flush-free/)    
 ^c675473212

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (10/14) | 2014-10-07, 22:05 | Foul thing | c675473741 |

  
 Не знал про такое. Но все равно использовал std::endl, который, внезапно, тоже делает flush.   
 ^c675473741

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (11/14) | 2014-10-07, 22:08 | UNKNOWN | c675473951 |

  
 Даже я знал   
 ^c675473951

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (12/14) | 2014-10-07, 22:29 | zHz00 | c675475819 |

  
  [Foul thing](http://foulthing.diary.ru "Temporary Internet Flies")  , а можешь заменить endl на "\n" << flush и сравнить?   
 ^c675475819

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (13/14) | 2014-10-07, 22:48 | Foul thing | c675477245 |

  
 Примерно одинаково выходит, по 15 микросекунд на запись, но с flush чуть побыстрее, на десятые доли.   
   
 Но fwrite все равно быстрее: 0.1 мкс без очистки буфера и 1.9 мкс с очисткой через fflush().   
   
 Это, кстати, в билдере. В студии у меня другие цифры получились.   
 ^c675477245

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (14/14) | 2014-10-07, 22:51 | zHz00 | c675477465 |

  
  [Foul thing](http://foulthing.diary.ru "Temporary Internet Flies")  , хм, понтяно.   
 Что в студии другие -- это из-за разных реализаций стандартных библиотек.   
 ^c675477465