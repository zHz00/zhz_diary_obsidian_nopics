Проблемы тупого рефакторинга
============================

  
2020-10-10, 23:59  
 Была функция, которая что-то считала. У неё были переменные a, b, c.   
   
 Мне нужна была другая функция, которая тоже считала бы примерно то же самое, но два раза и чуть-чуть по-разному.   
   
 Я сделал два дубликата первой функции и вписал их последовательно в новую функцию. Подумав, я назвал переменные a1, b1, c1, a2, b2, c2. Первые были для первого расчёта, вторые для второго. А потом ничего не заработало.   
   
 А почему? Потому что кроме a, b, c у меня ещё был набор глобальных захардкоженых констант для вычислений. И константы эти назывались a0, a1, a2. Мои новые переменные их перекрывали.   
  
<https://diary.ru/~zHz00/p220008150_problemy-tupogo-refaktoringa.htm>  
  
Теги:  
[[Программирование]]  
[[Говнокод]]  
ID: p220008150  


Комментарии: 10
---------------

  


---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (1/10) | 2020-10-11, 05:00 | CD\_Eater | c749306513 |

  
 и компилятор не ругнулся на перекрытие имён?   
 ^c749306513

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (2/10) | 2020-10-11, 08:37 | zHz00 | c749306903 |

  
  [CD\_Eater](http://cd-eater.diary.ru "Записки ДискоЕда")  , перекрытие глобальных идентификаторов локальными -- стандартная ситуация. Предупреждение не выдаётся, т.к. это не баг, а фича. Возможно есть способ его включить, но я о нём не знаю.   
 ^c749306903

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (3/10) | 2020-10-11, 10:21 | Xersareeth | c749307476 |

  
 Хм.. Если эти константы использовались в новых функциях, то странно что ты этого не заметил на этапе их написания. А если не использовались, то почему сломалось? Константы не такие уж и постоянные оказались?)   
 ^c749307476

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (4/10) | 2020-10-11, 19:17 | korrshun | c749314407 |

  
 -Wall ? =]   
 а ещё ты сделал git blame и настучал по голове человеку, что делает глобальные константы?   
 ^c749314407

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (5/10) | 2020-10-11, 19:31 | CD\_Eater | c749314669 |

  
 глобальные константы - это хорошо, но они должны иметь понятное и длинное название   
 а вот за глобальную константу a0 нужно стучать по голове   
 ^c749314669

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (6/10) | 2020-10-11, 19:44 | zHz00 | c749314919 |

  
  [LizardOfOzz](http://LizardsBurrow.diary.ru "One more night")  , эти константы использовались и в старых функциях. Их нормальное использование попало в новую функцию через копипасту, которую я не стал вычитывать, потому что "да там всё работает".   
  [korrshun](http://Igel-kun.diary.ru "kimi wo shiranai monogatari")  , мне себя по голове бить? Нет уж. А ты предлагаешь локальные константы что ли? Это коэффициенты в некотором математическом выражении, которое в разных качествах используется в разных местах.   
  [CD\_Eater](http://cd-eater.diary.ru "Записки ДискоЕда")  , во, про длинное название -- это дельно. Короткие получились, потому что мне принесли эти константы наши математики вместе с выражением типа y=a0\*x0+a1\*x1...   
 ^c749314919

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (7/10) | 2020-10-11, 20:07 | Xersareeth | c749315310 |

  
 > Короткие получились, потому что мне принесли эти константы наши математики вместе с выражением типа y=a0\*x0+a1\*x1   
 Я бы рассмотрел возможность оформить всё это выражение как функцию с понятным названием и константами, скрытыми внутри.   
 ^c749315310

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (8/10) | 2020-10-11, 21:12 | korrshun | c749316516 |

  
  [zHz00](https://zHz00.diary.ru "Untitled")  , я себя регулярно по голове бью за сделанные ранее глупости. это норма.   
 ![](http://static.diary.ru/userdir/6/7/8/5/678580/86916736.jpg)   
 В общем случае да, константы именовать посемантичнее и делать их как можно более локальными. Я после того как стукнулся головой об нечто аналогичное, всегда их объявляю локально. (хотя этож сишечка, у вас их там можно ненароком переписать ![:(](http://static.diary.ru/picture/1146.gif) )   
   
 Ну и да, логично написать какую-нибудь inline-функцию для сложных мат. портянок, если они повторяются из раза в раз.   
 Хм. хотя тут сложный момент, т.к. когда приходится матан кодить, то там чтоб записать какое-нибудь численное интегрирование, приходится небольшую простынку написать для этого вместо одной строки в оригинальной формуле. Но когда формула повторяется один в один, то 100% лучше инкапсулировать, и пусть компилятор это инлайнить пытается. Случаются, правда, серьёзные ограничения на if вычислительном коде, т.е. если оно почти такое, но другое, то возможно придётся копипастить, что печально. А скопипастить с константами нельзя там, или вы жестите и через них подгоняете под реальный мир, компилируя код под конкретную установку? Это тоже очень печально и лучше так не делать, т.к. это не константы на самом деле.   
 ^c749316516

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (9/10) | 2020-10-12, 15:32 | Foul thing | c749324726 |

  
 Я бы сделал глобальные константы с длинными и понятными именами, а внутри локальной функции создал бы для них короткие алиасы, например, по конст ссылке.   
 ^c749324726

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (10/10) | 2020-10-12, 16:16 | zHz00 | c749325331 |

  
  [Foul thing](http://foulthing.diary.ru "Temporary Internet Flies")  , ооо, отличная идея!   
  [korrshun](http://Igel-kun.diary.ru "kimi wo shiranai monogatari")  ,   
 >>А скопипастить с константами нельзя там, или вы жестите и через них подгоняете под реальный мир, компилируя код под конкретную установку?   
   
   
 Скопипастить можно, но не нужно. Хотя шансы того, что константы эти будут меняться когда либо вообще -- крайне малы.   
 ^c749325331