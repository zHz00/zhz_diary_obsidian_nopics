Свиноматка
==========

  
2015-06-22, 23:53  
 Хуже всего, если баг в программе то проявляется, то нет, по непонятному расписанию.   
   
 Практика показывает, что в таких случаях баг чаще всего вызван многопоточностью. То есть, когда несколько частей программы выполняются одновременно. Многопоточность -- действительно сложная тема со множеством подводных камней.   
   
 Если вы обнаружили подобный баг, то следует проверить следующее:   
 1) Что доступ к внешним устройствам есть только у одного потока. Если есть сомнения, следует сделать специальную функцию доступа к нему, которая будет работать через взаимоисключение (т.е. мьютекс, критическая секция и пр.). Весь доступ к устройству должен осуществляться через неё.   
 2) Что доступ к внутренним ресурсам (особенно, к памяти) размером больше ширины шины данных тоже сделан через взаимоисключения (см. примечание ниже).   
 3) И, наконец, что вы не применяете многопоточно библиотеки, которые для этого не предназначены. Если предназначены, обычно стоит пометка в документации -- thread-safe. Одна из таких библиотек, которая не предназначена -- VCL (C++ Builder, Delphi). Когда-то я не знал, что она не поддерживает многопоточность и менял, к примеру, надписи на кнопках из разных потоков. Это приводило к совершенно невообразимым глюкам.   
   
  **Внимание.**  Примечание к п.2. На некоторых процессорах доступ к невыровненным данным выполняется в несколько тактов. Выровненными считаются данные, расположенные по адресам, равным n\*ширина шины данных, где n -- целое неотрицательное число. Т.е. если ваша переменная размером 4 байта расположена по адресу 13, то её считывание на 32-битном процессоре может происходит следующим образом: процессор считывает байты 12-15, сохраняет во временный регистр, потом 16-19, сохраняет в другой регистр, сдвигает 12-15 влево на 8 бит, записывает старшие 24 бита в старшие 24 бита целевого регистра, потом сдгвигает 16-19 вправо на 24 бита, записывает младшие 8 бит в младшие 8 бит целевого регистра. Данный алгоритм является примером, фактическая реализация может быть иной. За это время потоки могли переключиться уже несколько раз. Будьте осторожны. Если же адрес переменной изначально был 12, то всё проходит в 1 такт.   
  
<https://diary.ru/~zHz00/p204698987_svinomatka.htm>  
  
Теги:  
[[Программирование]]  
[[Очевидное-невероятное]]  
ID: p204698987  


Комментарии: 8
--------------

  


---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (1/8) | 2015-06-23, 09:52 | Гость | c690922727 |

  
 Один раз - не свинопас.   
 ^c690922727

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (2/8) | 2015-06-24, 23:59 | himself | c691015559 |

  
 Почему свиноматка?   
   
  *размером больше ширины шины данных*    
 И меньше тоже. A++ из двух потоков рано или поздно кончится плохо. Без блокировок можно использовать:   
 1. Переменные, локальные для потока.   
 2. Атомарные операции по отдельности (чтение, присвоение, проверка, Interlocked\*\*\*), но не их комбинации.   
 Существует целая отрасль, в которой свои талмуды и профессионалы - lockless synchronization. Типичный приём - lockless однократная инициализация:   
   
 if (object == NULL) { tmp\_object = CreateObject(); if (InterlockedCompareExchange(object, NULL, tmp\_object) != NULL) DeleteObject(object);}   
   
 Т.е. создать, попробовать заменить NULL на него, но если там был не NULL, то кто-то успел раньше, уничтожить лишний object.   
   
 А ещё есть гейзенбаги, это которые исчезают, когда на них смотришь отладчиком (или логом) ![:)](http://static.diary.ru/picture/3.gif)   
 ^c691015559

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (3/8) | 2015-06-25, 18:16 | zHz00 | c691048101 |

  
 Свиноматка работает в несколько потоков же.   
   
 Что а плюс плюс закончится плохо -- да. Про это надо подправить. Спасибо.   
 ^c691048101

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (4/8) | 2015-07-01, 22:48 | Knows Ajed | c691337732 |

  
 Меня всегда в глубине души ужасали рекомендации многих учебников "гарантировать", что процедура А запустится раньше, чем процедура Б в параллельном потоке. Поставить оператор паузы ненулевой длины во втором потоке перед Б! \*снова содрогнулся\*   
 ^c691337732

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (5/8) | 2015-07-01, 23:50 | zHz00 | c691341535 |

  
 О, а дай-ка мне все эти учебники. Операторы паузы -- штука тяжёлая. В нашем ПО они регулярно применяются, но не для того, что ты пишешь, а для того, чтобы быть уверенным, что наши внешние устройства успеют получить и обработать отправленные им сообщения. Это всё равно плохо, но лучше чем то, что пишешь ты, т.к. устройства на контроллерах, а там жёсткое время выполнение.   
 ^c691341535

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (6/8) | 2015-07-02, 09:59 | Knows Ajed | c691351856 |

  
  [zHz00](https://zHz00.diary.ru "Untitled")  , дать, чтобы сжечь? Увы, почти все они - в электронном виде (я пират, йарр). Да и сам уже их не найду.   
   
 Ну, для гарантии (не 100%, но гарантия 100% - всегда ЛожьПП) получения и отправки сообщений с внешних устройств - в принципе, что ещё делать остаётся, управляющие сигналы а-ля мьютексы и проч. не всегда можно (или нужно) вводить в протокол. А с контроллерами всё действительно можно "подогнать" под эм... кадр.   
 Так что... что сказать-то... В общем, уверен, всё правильно делаете.   
 ^c691351856

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (7/8) | 2015-07-02, 13:13 | zHz00 | c691360322 |

  
 Интересно, что люди пишут, т.к. мои сведения из этой области почёрпнуты из пары лекций специалиста в этой области, который работал с этим по работе (он у нас в институте читал курс связанный с программированием), бесед с несколькими братьями по разуму и личного опыта. Ну и документации. Что старый пират это понятно, но можешь хотя бы названия сказать. Или прислать в умейл.   
 ^c691360322

---



|         #         |              Дата              |                     Автор                     |           ID           |
| --- | --- | --- | --- |
| (8/8) | 2015-07-03, 00:23 | Knows Ajed | c691393178 |

  
  [zHz00](https://zHz00.diary.ru "Untitled")  , обязательно поищу. Где-то точно валялись...   
 ^c691393178